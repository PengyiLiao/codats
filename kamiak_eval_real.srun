#!/bin/bash
#SBATCH --job-name=eval_real
#SBATCH --output=slurm_logs/eval_%A_%a.out
#SBATCH --error=slurm_logs/eval_%A_%a.err
#SBATCH --cpus-per-task=3
#SBATCH --gres=gpu:1
#SBATCH --partition=cook,free_gpu,cahnrs_gpu,kamiak
#SBATCH --time=0-01:00:00
#SBATCH --mem=20G
#SBATCH --array=0-1499

# My computer
#gpumem=4500
# SBATCH --partition=cook
# SBATCH --cpus-per-task=4
# SBATCH --gres=gpu:0
# SBATCH --mem=10G
# Kamiak
gpumem=0
# SBATCH --partition=cook,free_gpu,cahnrs_gpu,kamiak
# SBATCH --cpus-per-task=3
# SBATCH --gres=gpu:1
# SBATCH --mem=20G

. kamiak_config.sh

# Errors
handle_terminate() { echo "Exiting"; exit 1; }
handle_error() { echo "Error occured -- exiting"; exit 1; }
trap "handle_terminate" SIGTERM SIGINT

# Get suffix, i.e. files stored in kamiak-{models,logs}-suffix
suffix=$1; shift
[[ -z $suffix ]] && { echo "no suffix specified"; handle_error; }

# Adapt in both directions, then do upper bound
model=fcn
methods=("dann_grl" "dann_grl_dg" "sleep_dg" "dann_grl_gs" "none")
#variants=("best" "last")
variants=("best")
# number of adaptation problems = 300
sources=("ucihar_n1_0" "ucihar_n1_1" "ucihar_n1_2" "ucihar_n1_1" "ucihar_n1_3" "ucihar_n1_4" "ucihar_n1_5" "ucihar_n1_4" "ucihar_n1_3" "ucihar_n1_6" "ucihar_n1_7" "ucihar_n1_5" "ucihar_n1_0" "ucihar_n1_8" "ucihar_n1_9" "ucihar_n7_0" "ucihar_n7_1" "ucihar_n7_2" "ucihar_n7_3" "ucihar_n7_4" "ucihar_n7_5" "ucihar_n7_6" "ucihar_n7_7" "ucihar_n7_8" "ucihar_n7_9" "ucihar_n7_10" "ucihar_n7_11" "ucihar_n7_12" "ucihar_n7_13" "ucihar_n7_14" "ucihar_n13_0" "ucihar_n13_1" "ucihar_n13_2" "ucihar_n13_3" "ucihar_n13_4" "ucihar_n13_5" "ucihar_n13_6" "ucihar_n13_7" "ucihar_n13_8" "ucihar_n13_9" "ucihar_n13_10" "ucihar_n13_11" "ucihar_n13_12" "ucihar_n13_13" "ucihar_n13_14" "ucihar_n19_0" "ucihar_n19_1" "ucihar_n19_2" "ucihar_n19_3" "ucihar_n19_4" "ucihar_n19_5" "ucihar_n19_6" "ucihar_n19_7" "ucihar_n19_8" "ucihar_n19_9" "ucihar_n19_10" "ucihar_n19_11" "ucihar_n19_12" "ucihar_n19_13" "ucihar_n19_14" "ucihar_n25_0" "ucihar_n25_1" "ucihar_n25_2" "ucihar_n25_3" "ucihar_n25_4" "ucihar_n25_5" "ucihar_n25_6" "ucihar_n25_7" "ucihar_n25_8" "ucihar_n25_9" "ucihar_n25_10" "ucihar_n25_11" "ucihar_n25_12" "ucihar_n25_13" "ucihar_n25_14" "uwave_n1_0" "uwave_n1_1" "uwave_n1_2" "uwave_n1_3" "uwave_n1_4" "uwave_n1_5" "uwave_n1_2" "uwave_n1_6" "uwave_n1_5" "uwave_n1_1" "uwave_n1_3" "uwave_n1_5" "uwave_n1_7" "uwave_n1_0" "uwave_n1_3" "uwave_n2_0" "uwave_n2_1" "uwave_n2_2" "uwave_n2_3" "uwave_n2_1" "uwave_n2_4" "uwave_n2_5" "uwave_n2_6" "uwave_n2_7" "uwave_n2_8" "uwave_n2_9" "uwave_n2_10" "uwave_n2_11" "uwave_n2_12" "uwave_n2_13" "uwave_n3_0" "uwave_n3_1" "uwave_n3_2" "uwave_n3_3" "uwave_n3_4" "uwave_n3_5" "uwave_n3_6" "uwave_n3_7" "uwave_n3_8" "uwave_n3_0" "uwave_n3_9" "uwave_n3_10" "uwave_n3_11" "uwave_n3_12" "uwave_n3_13" "uwave_n4_0" "uwave_n4_1" "uwave_n4_2" "uwave_n4_3" "uwave_n4_4" "uwave_n4_5" "uwave_n4_6" "uwave_n4_7" "uwave_n4_8" "uwave_n4_9" "uwave_n4_10" "uwave_n4_11" "uwave_n4_12" "uwave_n4_13" "uwave_n4_14" "uwave_n5_0" "uwave_n5_1" "uwave_n5_2" "uwave_n5_3" "uwave_n5_4" "uwave_n5_5" "uwave_n5_6" "uwave_n5_7" "uwave_n5_8" "uwave_n5_9" "uwave_n5_5" "uwave_n5_10" "uwave_n5_11" "uwave_n5_12" "uwave_n5_13" "ucihhar_n1_0" "ucihhar_n1_1" "ucihhar_n1_2" "ucihhar_n1_2" "ucihhar_n1_0" "ucihhar_n1_1" "ucihhar_n1_2" "ucihhar_n1_3" "ucihhar_n1_4" "ucihhar_n1_4" "ucihhar_n1_3" "ucihhar_n1_5" "ucihhar_n1_6" "ucihhar_n1_3" "ucihhar_n1_1" "ucihhar_n2_0" "ucihhar_n2_1" "ucihhar_n2_2" "ucihhar_n2_3" "ucihhar_n2_4" "ucihhar_n2_2" "ucihhar_n2_5" "ucihhar_n2_6" "ucihhar_n2_7" "ucihhar_n2_8" "ucihhar_n2_9" "ucihhar_n2_10" "ucihhar_n2_11" "ucihhar_n2_8" "ucihhar_n2_10" "ucihhar_n3_0" "ucihhar_n3_1" "ucihhar_n3_2" "ucihhar_n3_3" "ucihhar_n3_4" "ucihhar_n3_5" "ucihhar_n3_6" "ucihhar_n3_7" "ucihhar_n3_8" "ucihhar_n3_9" "ucihhar_n3_10" "ucihhar_n3_11" "ucihhar_n3_3" "ucihhar_n3_12" "ucihhar_n3_13" "ucihhar_n4_0" "ucihhar_n4_1" "ucihhar_n4_2" "ucihhar_n4_3" "ucihhar_n4_4" "ucihhar_n4_5" "ucihhar_n4_6" "ucihhar_n4_7" "ucihhar_n4_8" "ucihhar_n4_9" "ucihhar_n4_10" "ucihhar_n4_11" "ucihhar_n4_12" "ucihhar_n4_13" "ucihhar_n4_14" "ucihhar_n5_0" "ucihhar_n5_1" "ucihhar_n5_2" "ucihhar_n5_3" "ucihhar_n5_4" "ucihhar_n5_5" "ucihhar_n5_6" "ucihhar_n5_7" "ucihhar_n5_8" "ucihhar_n5_9" "ucihhar_n5_10" "ucihhar_n5_11" "ucihhar_n5_12" "ucihhar_n5_13" "ucihhar_n5_14" "wisdm_n1_0" "wisdm_n1_1" "wisdm_n1_2" "wisdm_n1_3" "wisdm_n1_4" "wisdm_n1_5" "wisdm_n1_6" "wisdm_n1_7" "wisdm_n1_8" "wisdm_n1_9" "wisdm_n1_10" "wisdm_n1_11" "wisdm_n1_12" "wisdm_n1_2" "wisdm_n1_13" "wisdm_n11_0" "wisdm_n11_1" "wisdm_n11_2" "wisdm_n11_3" "wisdm_n11_4" "wisdm_n11_5" "wisdm_n11_6" "wisdm_n11_7" "wisdm_n11_8" "wisdm_n11_9" "wisdm_n11_10" "wisdm_n11_11" "wisdm_n11_12" "wisdm_n11_13" "wisdm_n11_14" "wisdm_n21_0" "wisdm_n21_1" "wisdm_n21_2" "wisdm_n21_3" "wisdm_n21_4" "wisdm_n21_5" "wisdm_n21_6" "wisdm_n21_7" "wisdm_n21_8" "wisdm_n21_9" "wisdm_n21_10" "wisdm_n21_11" "wisdm_n21_12" "wisdm_n21_13" "wisdm_n21_14" "wisdm_n31_0" "wisdm_n31_1" "wisdm_n31_2" "wisdm_n31_3" "wisdm_n31_4" "wisdm_n31_5" "wisdm_n31_6" "wisdm_n31_7" "wisdm_n31_8" "wisdm_n31_9" "wisdm_n31_10" "wisdm_n31_11" "wisdm_n31_12" "wisdm_n31_13" "wisdm_n31_14" "wisdm_n41_0" "wisdm_n41_1" "wisdm_n41_2" "wisdm_n41_3" "wisdm_n41_4" "wisdm_n41_5" "wisdm_n41_6" "wisdm_n41_7" "wisdm_n41_8" "wisdm_n41_9" "wisdm_n41_10" "wisdm_n41_11" "wisdm_n41_12" "wisdm_n41_13" "wisdm_n41_14")
targets=("ucihar_t1" "ucihar_t1" "ucihar_t1" "ucihar_t2" "ucihar_t2" "ucihar_t2" "ucihar_t3" "ucihar_t3" "ucihar_t3" "ucihar_t4" "ucihar_t4" "ucihar_t4" "ucihar_t5" "ucihar_t5" "ucihar_t5" "ucihar_t1" "ucihar_t1" "ucihar_t1" "ucihar_t2" "ucihar_t2" "ucihar_t2" "ucihar_t3" "ucihar_t3" "ucihar_t3" "ucihar_t4" "ucihar_t4" "ucihar_t4" "ucihar_t5" "ucihar_t5" "ucihar_t5" "ucihar_t1" "ucihar_t1" "ucihar_t1" "ucihar_t2" "ucihar_t2" "ucihar_t2" "ucihar_t3" "ucihar_t3" "ucihar_t3" "ucihar_t4" "ucihar_t4" "ucihar_t4" "ucihar_t5" "ucihar_t5" "ucihar_t5" "ucihar_t1" "ucihar_t1" "ucihar_t1" "ucihar_t2" "ucihar_t2" "ucihar_t2" "ucihar_t3" "ucihar_t3" "ucihar_t3" "ucihar_t4" "ucihar_t4" "ucihar_t4" "ucihar_t5" "ucihar_t5" "ucihar_t5" "ucihar_t1" "ucihar_t1" "ucihar_t1" "ucihar_t2" "ucihar_t2" "ucihar_t2" "ucihar_t3" "ucihar_t3" "ucihar_t3" "ucihar_t4" "ucihar_t4" "ucihar_t4" "ucihar_t5" "ucihar_t5" "ucihar_t5" "uwave_t1" "uwave_t1" "uwave_t1" "uwave_t2" "uwave_t2" "uwave_t2" "uwave_t3" "uwave_t3" "uwave_t3" "uwave_t4" "uwave_t4" "uwave_t4" "uwave_t5" "uwave_t5" "uwave_t5" "uwave_t1" "uwave_t1" "uwave_t1" "uwave_t2" "uwave_t2" "uwave_t2" "uwave_t3" "uwave_t3" "uwave_t3" "uwave_t4" "uwave_t4" "uwave_t4" "uwave_t5" "uwave_t5" "uwave_t5" "uwave_t1" "uwave_t1" "uwave_t1" "uwave_t2" "uwave_t2" "uwave_t2" "uwave_t3" "uwave_t3" "uwave_t3" "uwave_t4" "uwave_t4" "uwave_t4" "uwave_t5" "uwave_t5" "uwave_t5" "uwave_t1" "uwave_t1" "uwave_t1" "uwave_t2" "uwave_t2" "uwave_t2" "uwave_t3" "uwave_t3" "uwave_t3" "uwave_t4" "uwave_t4" "uwave_t4" "uwave_t5" "uwave_t5" "uwave_t5" "uwave_t1" "uwave_t1" "uwave_t1" "uwave_t2" "uwave_t2" "uwave_t2" "uwave_t3" "uwave_t3" "uwave_t3" "uwave_t4" "uwave_t4" "uwave_t4" "uwave_t5" "uwave_t5" "uwave_t5" "ucihhar_t0" "ucihhar_t0" "ucihhar_t0" "ucihhar_t1" "ucihhar_t1" "ucihhar_t1" "ucihhar_t2" "ucihhar_t2" "ucihhar_t2" "ucihhar_t3" "ucihhar_t3" "ucihhar_t3" "ucihhar_t4" "ucihhar_t4" "ucihhar_t4" "ucihhar_t0" "ucihhar_t0" "ucihhar_t0" "ucihhar_t1" "ucihhar_t1" "ucihhar_t1" "ucihhar_t2" "ucihhar_t2" "ucihhar_t2" "ucihhar_t3" "ucihhar_t3" "ucihhar_t3" "ucihhar_t4" "ucihhar_t4" "ucihhar_t4" "ucihhar_t0" "ucihhar_t0" "ucihhar_t0" "ucihhar_t1" "ucihhar_t1" "ucihhar_t1" "ucihhar_t2" "ucihhar_t2" "ucihhar_t2" "ucihhar_t3" "ucihhar_t3" "ucihhar_t3" "ucihhar_t4" "ucihhar_t4" "ucihhar_t4" "ucihhar_t0" "ucihhar_t0" "ucihhar_t0" "ucihhar_t1" "ucihhar_t1" "ucihhar_t1" "ucihhar_t2" "ucihhar_t2" "ucihhar_t2" "ucihhar_t3" "ucihhar_t3" "ucihhar_t3" "ucihhar_t4" "ucihhar_t4" "ucihhar_t4" "ucihhar_t0" "ucihhar_t0" "ucihhar_t0" "ucihhar_t1" "ucihhar_t1" "ucihhar_t1" "ucihhar_t2" "ucihhar_t2" "ucihhar_t2" "ucihhar_t3" "ucihhar_t3" "ucihhar_t3" "ucihhar_t4" "ucihhar_t4" "ucihhar_t4" "wisdm_t0" "wisdm_t0" "wisdm_t0" "wisdm_t1" "wisdm_t1" "wisdm_t1" "wisdm_t2" "wisdm_t2" "wisdm_t2" "wisdm_t3" "wisdm_t3" "wisdm_t3" "wisdm_t4" "wisdm_t4" "wisdm_t4" "wisdm_t0" "wisdm_t0" "wisdm_t0" "wisdm_t1" "wisdm_t1" "wisdm_t1" "wisdm_t2" "wisdm_t2" "wisdm_t2" "wisdm_t3" "wisdm_t3" "wisdm_t3" "wisdm_t4" "wisdm_t4" "wisdm_t4" "wisdm_t0" "wisdm_t0" "wisdm_t0" "wisdm_t1" "wisdm_t1" "wisdm_t1" "wisdm_t2" "wisdm_t2" "wisdm_t2" "wisdm_t3" "wisdm_t3" "wisdm_t3" "wisdm_t4" "wisdm_t4" "wisdm_t4" "wisdm_t0" "wisdm_t0" "wisdm_t0" "wisdm_t1" "wisdm_t1" "wisdm_t1" "wisdm_t2" "wisdm_t2" "wisdm_t2" "wisdm_t3" "wisdm_t3" "wisdm_t3" "wisdm_t4" "wisdm_t4" "wisdm_t4" "wisdm_t0" "wisdm_t0" "wisdm_t0" "wisdm_t1" "wisdm_t1" "wisdm_t1" "wisdm_t2" "wisdm_t2" "wisdm_t2" "wisdm_t3" "wisdm_t3" "wisdm_t3" "wisdm_t4" "wisdm_t4" "wisdm_t4")

# Make sure we're using the right number
correct_min=0
correct_max=$(( ${#methods[@]} * ${#variants[@]} * ${#sources[@]} - 1))
[[ ${#sources[@]} == ${#targets[@]} ]] || \
    { echo "source/target sizes should match"; handle_error; }
[[ $SLURM_ARRAY_TASK_MIN == $correct_min ]] || \
    { echo "array min should be $correct_min"; handle_error; }
[[ $SLURM_ARRAY_TASK_MAX == $correct_max ]] || \
    { echo "array max should be $correct_max"; handle_error; }

# Indexing: https://stackoverflow.com/a/34363187
index=$SLURM_ARRAY_TASK_ID
index1max=${#sources[@]}
index2max=${#variants[@]}
index3=$((index / (index1max * index2max)))
index=$((index - index3 * index1max * index2max))
index2=$((index / index1max))
index1=$((index % index1max))

method="${methods[$index3]}"
variant="${variants[$index2]}"
source="${sources[$index1]}"
target="${targets[$index1]}"

# Output name uses method from above not the "none" for "upper"
out="results_${suffix}_$variant-$method-$source-$target.txt"

# Upper bound is actually "none" but without a target domain and with other args
additional_args=()
if [[ $method == "upper" ]]; then
    method="none"
    source="$target"
    target=""
    #additional_args+=("--best_source")
fi

# For DG vs. DA always pass these for being more fair.
additional_args+=("--best_source")

# OOM errors
additional_args+=("--eval_batch=1024")

# Model
if [[ $method == "vrada" || $method == "rdann" ]]; then
    model="$method"
else
    model="fcn"
fi

# Argument if evaluating last model
if [[ $variant == "last" ]]; then
    additional_args+=("--last")
fi

echo "$suffix #$SLURM_ARRAY_TASK_ID" > "$out"
echo "Method: $method" >> "$out"
echo "Other args: $@" >> "$out"
echo "$source --> $target" >> "$out"

cd "$remotedir"
export OMP_NUM_THREADS=$SLURM_CPUS_PER_TASK
module load cuda/10.0.130 cudnn/7.5.1.10_cuda10.0 python3/3.6.5
{ python3 main_eval.py \
    --logdir="$logFolder-$suffix" --modeldir="$modelFolder-$suffix" \
    --jobs=1 --gpus=1 --gpumem="$gpumem" \
    --match="${source}-${target}-${model}-${method}-[0-9]*" \
    "${additional_args[@]}" "$@" || handle_error; } | \
    tee -a "$out"
