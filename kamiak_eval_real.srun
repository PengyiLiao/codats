#!/bin/bash
#SBATCH --job-name=eval_real
#SBATCH --output=slurm_logs/eval_%A_%a.out
#SBATCH --error=slurm_logs/eval_%A_%a.err
#SBATCH --cpus-per-task=3
#SBATCH --gres=gpu:1
#SBATCH --partition=cook,free_gpu,cahnrs_gpu,kamiak
#SBATCH --time=0-01:00:00
#SBATCH --mem=20G
#SBATCH --array=0-224

# My computer
#gpumem=4500
# SBATCH --partition=cook
# SBATCH --cpus-per-task=4
# SBATCH --gres=gpu:0
# SBATCH --mem=10G
# Kamiak
gpumem=0
# SBATCH --partition=cook,free_gpu,cahnrs_gpu,kamiak
# SBATCH --cpus-per-task=3
# SBATCH --gres=gpu:1
# SBATCH --mem=20G

. kamiak_config.sh

# Errors
handle_terminate() { echo "Exiting"; exit 1; }
handle_error() { echo "Error occured -- exiting"; exit 1; }
trap "handle_terminate" SIGTERM SIGINT

# Get suffix, i.e. files stored in kamiak-{models,logs}-suffix
suffix=$1; shift
[[ -z $suffix ]] && { echo "no suffix specified"; handle_error; }

# Adapt in both directions, then do upper bound
model=fcn
methods=("dann_grl")
#variants=("best" "last")
variants=("best")
# number of adaptation problems = 225
sources=("ucihar_n1_20" "ucihar_n1_4" "ucihar_n1_12" "ucihar_n1_4" "ucihar_n1_23" "ucihar_n1_21" "ucihar_n1_16" "ucihar_n1_21" "ucihar_n1_23" "ucihar_n1_10" "ucihar_n1_27" "ucihar_n1_16" "ucihar_n1_20" "ucihar_n1_26" "ucihar_n1_17" "ucihar_n7_20,16,12,24,23,8,7" "ucihar_n7_4,23,14,9,21,17,18" "ucihar_n7_12,5,25,2,14,16,10" "ucihar_n7_4,20,1,13,26,18,24" "ucihar_n7_23,26,11,7,18,28,5" "ucihar_n7_21,20,18,16,24,17,8" "ucihar_n7_16,14,6,8,15,29,10" "ucihar_n7_21,9,4,27,12,22,6" "ucihar_n7_23,1,15,20,7,27,26" "ucihar_n7_10,15,24,18,25,7,1" "ucihar_n7_27,23,18,6,21,24,20" "ucihar_n7_16,10,27,22,6,28,13" "ucihar_n7_20,7,25,8,17,18,19" "ucihar_n7_26,23,8,30,20,14,9" "ucihar_n7_26,4,19,20,24,29,11" "ucihar_n13_20,16,12,24,23,8,7,14,13,17,11,26,21" "ucihar_n13_4,23,14,9,21,17,18,28,30,11,13,25,16" "ucihar_n13_12,5,25,2,14,16,10,30,18,7,17,6,23" "ucihar_n13_4,20,1,13,26,18,24,11,15,5,17,6,8" "ucihar_n13_23,26,11,7,18,28,5,22,8,12,4,16,1" "ucihar_n13_21,20,18,16,24,17,8,3,4,22,6,14,13" "ucihar_n13_16,14,6,8,15,29,10,4,23,22,28,2,27" "ucihar_n13_21,9,4,27,12,22,6,15,10,23,1,7,2" "ucihar_n13_23,1,15,20,7,27,26,13,11,28,5,21,16" "ucihar_n13_10,15,24,18,25,7,1,11,13,26,30,28,17" "ucihar_n13_27,23,18,6,21,24,20,5,3,9,12,19,29" "ucihar_n13_16,10,27,22,6,28,13,15,1,12,14,5,11" "ucihar_n13_20,7,25,8,17,18,19,29,4,26,13,2,15" "ucihar_n13_26,23,8,30,20,14,9,12,29,3,10,13,15" "ucihar_n13_26,4,19,20,24,29,11,25,21,14,8,16,30" "ucihar_n19_20,16,12,24,23,8,7,14,13,17,11,26,21,30,18,28,3,15,4" "ucihar_n19_4,23,14,9,21,17,18,28,30,11,13,25,16,19,3,5,22,8,6" "ucihar_n19_12,5,25,2,14,16,10,30,18,7,17,6,23,26,15,24,27,29,9" "ucihar_n19_4,20,1,13,26,18,24,11,15,5,17,6,8,27,29,23,21,3,12" "ucihar_n19_23,26,11,7,18,28,5,22,8,12,4,16,1,21,3,17,30,29,13" "ucihar_n19_21,20,18,16,24,17,8,3,4,22,6,14,13,28,9,7,15,11,26" "ucihar_n19_16,14,6,8,15,29,10,4,23,22,28,2,27,20,24,9,11,13,5" "ucihar_n19_21,9,4,27,12,22,6,15,10,23,1,7,2,29,17,5,20,18,16" "ucihar_n19_23,1,15,20,7,27,26,13,11,28,5,21,16,25,14,24,22,6,19" "ucihar_n19_10,15,24,18,25,7,1,11,13,26,30,28,17,3,20,6,16,19,21" "ucihar_n19_27,23,18,6,21,24,20,5,3,9,12,19,29,13,26,11,16,10,22" "ucihar_n19_16,10,27,22,6,28,13,15,1,12,14,5,11,23,8,9,19,21,24" "ucihar_n19_20,7,25,8,17,18,19,29,4,26,13,2,15,21,27,1,3,28,16" "ucihar_n19_26,23,8,30,20,14,9,12,29,3,10,13,15,2,17,6,4,25,27" "ucihar_n19_26,4,19,20,24,29,11,25,21,14,8,16,30,9,13,7,23,6,12" "ucihar_n25_20,16,12,24,23,8,7,14,13,17,11,26,21,30,18,28,3,15,4,19,29,6,27,9,10" "ucihar_n25_4,23,14,9,21,17,18,28,30,11,13,25,16,19,3,5,22,8,6,29,12,15,24,7,26" "ucihar_n25_12,5,25,2,14,16,10,30,18,7,17,6,23,26,15,24,27,29,9,3,4,8,20,13,21" "ucihar_n25_4,20,1,13,26,18,24,11,15,5,17,6,8,27,29,23,21,3,12,28,30,22,10,14,16" "ucihar_n25_23,26,11,7,18,28,5,22,8,12,4,16,1,21,3,17,30,29,13,14,24,15,20,10,27" "ucihar_n25_21,20,18,16,24,17,8,3,4,22,6,14,13,28,9,7,15,11,26,12,10,30,27,5,25" "ucihar_n25_16,14,6,8,15,29,10,4,23,22,28,2,27,20,24,9,11,13,5,25,17,12,21,1,18" "ucihar_n25_21,9,4,27,12,22,6,15,10,23,1,7,2,29,17,5,20,18,16,13,14,11,28,30,24" "ucihar_n25_23,1,15,20,7,27,26,13,11,28,5,21,16,25,14,24,22,6,19,8,17,10,30,18,29" "ucihar_n25_10,15,24,18,25,7,1,11,13,26,30,28,17,3,20,6,16,19,21,8,9,27,12,14,2" "ucihar_n25_27,23,18,6,21,24,20,5,3,9,12,19,29,13,26,11,16,10,22,1,25,30,2,14,8" "ucihar_n25_16,10,27,22,6,28,13,15,1,12,14,5,11,23,8,9,19,21,24,3,25,29,7,26,18" "ucihar_n25_20,7,25,8,17,18,19,29,4,26,13,2,15,21,27,1,3,28,16,11,22,30,6,14,10" "ucihar_n25_26,23,8,30,20,14,9,12,29,3,10,13,15,2,17,6,4,25,27,1,18,22,21,11,24" "ucihar_n25_26,4,19,20,24,29,11,25,21,14,8,16,30,9,13,7,23,6,12,1,27,28,15,22,3" "uwave_n1_3" "uwave_n1_5" "uwave_n1_4" "uwave_n1_8" "uwave_n1_7" "uwave_n1_6" "uwave_n1_4" "uwave_n1_2" "uwave_n1_6" "uwave_n1_5" "uwave_n1_8" "uwave_n1_6" "uwave_n1_1" "uwave_n1_3" "uwave_n1_8" "uwave_n2_3,5" "uwave_n2_5,8" "uwave_n2_5,4" "uwave_n2_4,7" "uwave_n2_8,5" "uwave_n2_7,1" "uwave_n2_6,7" "uwave_n2_4,6" "uwave_n2_2,1" "uwave_n2_3,6" "uwave_n2_6,3" "uwave_n2_5,1" "uwave_n2_4,6" "uwave_n2_8,1" "uwave_n2_8,4" "uwave_n3_3,5,6" "uwave_n3_5,8,4" "uwave_n3_5,4,6" "uwave_n3_4,7,1" "uwave_n3_8,5,7" "uwave_n3_7,1,5" "uwave_n3_6,7,2" "uwave_n3_4,6,2" "uwave_n3_2,1,5" "uwave_n3_3,6,5" "uwave_n3_6,3,7" "uwave_n3_5,1,6" "uwave_n3_4,6,8" "uwave_n3_8,1,6" "uwave_n3_8,4,6" "uwave_n4_3,5,6,4" "uwave_n4_5,8,4,6" "uwave_n4_5,4,6,3" "uwave_n4_4,7,1,5" "uwave_n4_8,5,7,3" "uwave_n4_7,1,5,6" "uwave_n4_6,7,2,4" "uwave_n4_4,6,2,7" "uwave_n4_2,1,5,7" "uwave_n4_3,6,5,2" "uwave_n4_6,3,7,5" "uwave_n4_5,1,6,8" "uwave_n4_4,6,8,2" "uwave_n4_8,1,6,3" "uwave_n4_8,4,6,2" "uwave_n5_3,5,6,4,8" "uwave_n5_5,8,4,6,2" "uwave_n5_5,4,6,3,7" "uwave_n5_4,7,1,5,8" "uwave_n5_8,5,7,3,1" "uwave_n5_7,1,5,6,3" "uwave_n5_6,7,2,4,8" "uwave_n5_4,6,2,7,5" "uwave_n5_2,1,5,7,8" "uwave_n5_3,6,5,2,8" "uwave_n5_6,3,7,5,1" "uwave_n5_5,1,6,8,2" "uwave_n5_4,6,8,2,1" "uwave_n5_8,1,6,3,7" "uwave_n5_8,4,6,2,1" "sleep_n1_17" "sleep_n1_3" "sleep_n1_23" "sleep_n1_13" "sleep_n1_10" "sleep_n1_25" "sleep_n1_16" "sleep_n1_0" "sleep_n1_5" "sleep_n1_2" "sleep_n1_10" "sleep_n1_4" "sleep_n1_18" "sleep_n1_1" "sleep_n1_23" "sleep_n6_17,13,10,20,19,7" "sleep_n6_3,13,12,8,25,4" "sleep_n6_23,1,9,24,11,25" "sleep_n6_13,12,14,10,20,15" "sleep_n6_10,8,0,14,6,2" "sleep_n6_25,8,10,12,19,22" "sleep_n6_16,5,1,12,8,19" "sleep_n6_0,14,10,12,25,6" "sleep_n6_5,6,9,16,7,19" "sleep_n6_2,17,4,23,0,13" "sleep_n6_10,19,12,20,16,6" "sleep_n6_4,11,22,18,2,10" "sleep_n6_18,15,13,8,25,5" "sleep_n6_1,10,13,3,24,0" "sleep_n6_23,1,3,13,14,11" "sleep_n11_17,13,10,20,19,7,6,11,16,22,12" "sleep_n11_3,13,12,8,25,4,10,23,18,16,22" "sleep_n11_23,1,9,24,11,25,6,16,14,22,15" "sleep_n11_13,12,14,10,20,15,2,0,16,4,24" "sleep_n11_10,8,0,14,6,2,18,22,21,17,24" "sleep_n11_25,8,10,12,19,22,7,23,17,2,11" "sleep_n11_16,5,1,12,8,19,18,14,23,11,22" "sleep_n11_0,14,10,12,25,6,15,4,7,13,20" "sleep_n11_5,6,9,16,7,19,23,12,14,13,18" "sleep_n11_2,17,4,23,0,13,9,21,10,12,6" "sleep_n11_10,19,12,20,16,6,0,25,9,13,1" "sleep_n11_4,11,22,18,2,10,19,12,9,15,24" "sleep_n11_18,15,13,8,25,5,0,7,3,12,10" "sleep_n11_1,10,13,3,24,0,25,6,16,15,12" "sleep_n11_23,1,3,13,14,11,6,0,16,10,15" "sleep_n16_17,13,10,20,19,7,6,11,16,22,12,18,2,15,23,14" "sleep_n16_3,13,12,8,25,4,10,23,18,16,22,21,17,15,2,20" "sleep_n16_23,1,9,24,11,25,6,16,14,22,15,4,17,5,13,8" "sleep_n16_13,12,14,10,20,15,2,0,16,4,24,11,5,7,17,19" "sleep_n16_10,8,0,14,6,2,18,22,21,17,24,20,12,4,3,9" "sleep_n16_25,8,10,12,19,22,7,23,17,2,11,0,16,24,9,15" "sleep_n16_16,5,1,12,8,19,18,14,23,11,22,24,13,20,3,7" "sleep_n16_0,14,10,12,25,6,15,4,7,13,20,23,9,24,11,17" "sleep_n16_5,6,9,16,7,19,23,12,14,13,18,1,24,22,10,20" "sleep_n16_2,17,4,23,0,13,9,21,10,12,6,24,11,15,1,25" "sleep_n16_10,19,12,20,16,6,0,25,9,13,1,23,22,17,2,14" "sleep_n16_4,11,22,18,2,10,19,12,9,15,24,8,17,5,21,0" "sleep_n16_18,15,13,8,25,5,0,7,3,12,10,14,2,20,9,22" "sleep_n16_1,10,13,3,24,0,25,6,16,15,12,21,2,18,5,8" "sleep_n16_23,1,3,13,14,11,6,0,16,10,15,21,22,24,20,19" "sleep_n21_17,13,10,20,19,7,6,11,16,22,12,18,2,15,23,14,3,24,5,25,8" "sleep_n21_3,13,12,8,25,4,10,23,18,16,22,21,17,15,2,20,7,5,24,11,14" "sleep_n21_23,1,9,24,11,25,6,16,14,22,15,4,17,5,13,8,2,3,7,19,12" "sleep_n21_13,12,14,10,20,15,2,0,16,4,24,11,5,7,17,19,8,18,6,3,21" "sleep_n21_10,8,0,14,6,2,18,22,21,17,24,20,12,4,3,9,5,15,13,16,25" "sleep_n21_25,8,10,12,19,22,7,23,17,2,11,0,16,24,9,15,18,13,3,20,14" "sleep_n21_16,5,1,12,8,19,18,14,23,11,22,24,13,20,3,7,10,4,21,25,17" "sleep_n21_0,14,10,12,25,6,15,4,7,13,20,23,9,24,11,17,5,18,21,16,22" "sleep_n21_5,6,9,16,7,19,23,12,14,13,18,1,24,22,10,20,0,11,3,21,8" "sleep_n21_2,17,4,23,0,13,9,21,10,12,6,24,11,15,1,25,14,20,8,16,22" "sleep_n21_10,19,12,20,16,6,0,25,9,13,1,23,22,17,2,14,5,15,18,21,7" "sleep_n21_4,11,22,18,2,10,19,12,9,15,24,8,17,5,21,0,20,25,1,13,7" "sleep_n21_18,15,13,8,25,5,0,7,3,12,10,14,2,20,9,22,6,21,17,16,19" "sleep_n21_1,10,13,3,24,0,25,6,16,15,12,21,2,18,5,8,20,7,9,11,17" "sleep_n21_23,1,3,13,14,11,6,0,16,10,15,21,22,24,20,19,8,25,12,5,9")
targets=("ucihar_t1" "ucihar_t1" "ucihar_t1" "ucihar_t2" "ucihar_t2" "ucihar_t2" "ucihar_t3" "ucihar_t3" "ucihar_t3" "ucihar_t4" "ucihar_t4" "ucihar_t4" "ucihar_t5" "ucihar_t5" "ucihar_t5" "ucihar_t1" "ucihar_t1" "ucihar_t1" "ucihar_t2" "ucihar_t2" "ucihar_t2" "ucihar_t3" "ucihar_t3" "ucihar_t3" "ucihar_t4" "ucihar_t4" "ucihar_t4" "ucihar_t5" "ucihar_t5" "ucihar_t5" "ucihar_t1" "ucihar_t1" "ucihar_t1" "ucihar_t2" "ucihar_t2" "ucihar_t2" "ucihar_t3" "ucihar_t3" "ucihar_t3" "ucihar_t4" "ucihar_t4" "ucihar_t4" "ucihar_t5" "ucihar_t5" "ucihar_t5" "ucihar_t1" "ucihar_t1" "ucihar_t1" "ucihar_t2" "ucihar_t2" "ucihar_t2" "ucihar_t3" "ucihar_t3" "ucihar_t3" "ucihar_t4" "ucihar_t4" "ucihar_t4" "ucihar_t5" "ucihar_t5" "ucihar_t5" "ucihar_t1" "ucihar_t1" "ucihar_t1" "ucihar_t2" "ucihar_t2" "ucihar_t2" "ucihar_t3" "ucihar_t3" "ucihar_t3" "ucihar_t4" "ucihar_t4" "ucihar_t4" "ucihar_t5" "ucihar_t5" "ucihar_t5" "uwave_t1" "uwave_t1" "uwave_t1" "uwave_t2" "uwave_t2" "uwave_t2" "uwave_t3" "uwave_t3" "uwave_t3" "uwave_t4" "uwave_t4" "uwave_t4" "uwave_t5" "uwave_t5" "uwave_t5" "uwave_t1" "uwave_t1" "uwave_t1" "uwave_t2" "uwave_t2" "uwave_t2" "uwave_t3" "uwave_t3" "uwave_t3" "uwave_t4" "uwave_t4" "uwave_t4" "uwave_t5" "uwave_t5" "uwave_t5" "uwave_t1" "uwave_t1" "uwave_t1" "uwave_t2" "uwave_t2" "uwave_t2" "uwave_t3" "uwave_t3" "uwave_t3" "uwave_t4" "uwave_t4" "uwave_t4" "uwave_t5" "uwave_t5" "uwave_t5" "uwave_t1" "uwave_t1" "uwave_t1" "uwave_t2" "uwave_t2" "uwave_t2" "uwave_t3" "uwave_t3" "uwave_t3" "uwave_t4" "uwave_t4" "uwave_t4" "uwave_t5" "uwave_t5" "uwave_t5" "uwave_t1" "uwave_t1" "uwave_t1" "uwave_t2" "uwave_t2" "uwave_t2" "uwave_t3" "uwave_t3" "uwave_t3" "uwave_t4" "uwave_t4" "uwave_t4" "uwave_t5" "uwave_t5" "uwave_t5" "sleep_t0" "sleep_t0" "sleep_t0" "sleep_t1" "sleep_t1" "sleep_t1" "sleep_t2" "sleep_t2" "sleep_t2" "sleep_t3" "sleep_t3" "sleep_t3" "sleep_t4" "sleep_t4" "sleep_t4" "sleep_t0" "sleep_t0" "sleep_t0" "sleep_t1" "sleep_t1" "sleep_t1" "sleep_t2" "sleep_t2" "sleep_t2" "sleep_t3" "sleep_t3" "sleep_t3" "sleep_t4" "sleep_t4" "sleep_t4" "sleep_t0" "sleep_t0" "sleep_t0" "sleep_t1" "sleep_t1" "sleep_t1" "sleep_t2" "sleep_t2" "sleep_t2" "sleep_t3" "sleep_t3" "sleep_t3" "sleep_t4" "sleep_t4" "sleep_t4" "sleep_t0" "sleep_t0" "sleep_t0" "sleep_t1" "sleep_t1" "sleep_t1" "sleep_t2" "sleep_t2" "sleep_t2" "sleep_t3" "sleep_t3" "sleep_t3" "sleep_t4" "sleep_t4" "sleep_t4" "sleep_t0" "sleep_t0" "sleep_t0" "sleep_t1" "sleep_t1" "sleep_t1" "sleep_t2" "sleep_t2" "sleep_t2" "sleep_t3" "sleep_t3" "sleep_t3" "sleep_t4" "sleep_t4" "sleep_t4")


# Make sure we're using the right number
correct_min=0
correct_max=$(( ${#methods[@]} * ${#variants[@]} * ${#sources[@]} - 1))
[[ ${#sources[@]} == ${#targets[@]} ]] || \
    { echo "source/target sizes should match"; handle_error; }
[[ $SLURM_ARRAY_TASK_MIN == $correct_min ]] || \
    { echo "array min should be $correct_min"; handle_error; }
[[ $SLURM_ARRAY_TASK_MAX == $correct_max ]] || \
    { echo "array max should be $correct_max"; handle_error; }

# Indexing: https://stackoverflow.com/a/34363187
index=$SLURM_ARRAY_TASK_ID
index1max=${#sources[@]}
index2max=${#variants[@]}
index3=$((index / (index1max * index2max)))
index=$((index - index3 * index1max * index2max))
index2=$((index / index1max))
index1=$((index % index1max))

method="${methods[$index3]}"
variant="${variants[$index2]}"
source="${sources[$index1]}"
target="${targets[$index1]}"

# Output name uses method from above not the "none" for "upper"
out="results_${suffix}_$variant-$method-$source-$target.txt"

# Upper bound is actually "none" but without a target domain and with other args
additional_args=()
if [[ $method == "upper" ]]; then
    method="none"
    source="$target"
    target=""
    additional_args+=("--best_source")
fi

# Model
if [[ $method == "vrada" || $method == "rdann" ]]; then
    model="$method"
else
    model="fcn"
fi

# Argument if evaluating last model
if [[ $variant == "last" ]]; then
    additional_args+=("--last")
fi

echo "$suffix #$SLURM_ARRAY_TASK_ID" > "$out"
echo "Method: $method" >> "$out"
echo "Other args: $@" >> "$out"
echo "$source --> $target" >> "$out"

cd "$remotedir"
export OMP_NUM_THREADS=$SLURM_CPUS_PER_TASK
module load cuda/10.0.130 cudnn/7.5.1.10_cuda10.0 python3/3.6.5
{ python3 main_eval.py \
    --logdir="$logFolder-$suffix" --modeldir="$modelFolder-$suffix" \
    --jobs=1 --gpus=1 --gpumem="$gpumem" \
    --match="${source}-${target}-${model}-${method}-[0-9]*" \
    "${additional_args[@]}" "$@" || handle_error; } | \
    tee -a "$out"
# --eval_batch=2048
